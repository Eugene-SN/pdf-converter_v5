# PDF Converter Pipeline v5

> Высокоточная конвертация **цифровых PDF** в Markdown с расширенной проверкой качества и опциональным переводом с китайского на английский или русский языки.

## Содержание
- [Обзор](#обзор)
- [Архитектура и взаимодействие модулей](#архитектура-и-взаимодействие-модулей)
- [Основные этапы обработки](#основные-этапы-обработки)
- [Модули и компоненты](#модули-и-компоненты)
  - [document_processor](#document_processor)
  - [translator](#translator)
  - [quality_assurance](#quality_assurance)
  - [Вспомогательные сервисы и инфраструктура](#вспомогательные-сервисы-и-инфраструктура)
- [Рабочие сценарии](#рабочие-сценарии)
  - [Конвертация цифровых PDF → Markdown](#конвертация-цифровых-pdf--markdown)
  - [Опциональный перевод Markdown](#опциональный-перевод-markdown)
- [Конфигурация](#конфигурация)
  - [.env и ключевые переменные](#env-и-ключевые-переменные)
  - [Настройка окружения](#настройка-окружения)
- [Структура репозитория](#структура-репозитория)
- [Отладка и мониторинг](#отладка-и-мониторинг)
- [Дальнейшее развитие](#дальнейшее-развитие)

## Обзор

Проект объединяет несколько сервисов и утилит для автоматизированной обработки цифровых PDF документов:

1. **Конвертация PDF → Markdown** без ухудшений, связанных с OCR, благодаря Docling-пайплайну.
2. **Пятиуровневая проверка качества** результата конвертации.
3. **Опциональный перевод** готовых Markdown-документов с китайского языка на английский или русский.
4. **Инфраструктурная интеграция** с Airflow, Prometheus, Grafana и Flask-API (при необходимости оркестрации или мониторинга).

Цель — гарантировать максимально точную структурированную выгрузку содержимого цифровых PDF с последующей локализацией.

## Архитектура и взаимодействие модулей

```mermaid
flowchart TD
    A[Входные PDF (input/)] --> B(convert-pdf-to-markdown.sh)
    B --> C[document_processor.local_converter]
    C --> D[DoclingProcessor]
    D --> E[Markdown + Metadata + Assets]
    E --> F[quality_assurance]
    E --> G[translate-documents.sh]
    G --> H[translator.translator]
    H --> I[Переведённые Markdown (output/en, output/ru)]
    B -. optional .-> J[Airflow orchestrator]
```

* `convert-pdf-to-markdown.sh` запускает локальный конвертер на Docling-движке (без OCR по умолчанию), управляет каталогами ввода/вывода и собирает JSON-результаты.
* `document_processor.local_converter` управляет жизненным циклом `DoclingProcessor`, выполняет асинхронную конвертацию PDF, нормализацию Markdown и сохранение метаданных.
* `DoclingProcessor` взаимодействует с Docling API, экспортирует таблицы, изображения и текстовую структуру, обеспечивая высокое качество Markdown.
* `quality_assurance` агрегирует пост-обработку и проверки, доступные для расширения (например, линтеры, валидация ссылок, проверка таблиц).
* `translate-documents.sh` и модуль `translator` выполняют перевод уже готовых Markdown-документов с китайского на английский/русский с помощью LLM-подходов.
* Инфраструктурные сервисы (Airflow, Prometheus, Grafana) обеспечивают оркестрацию и мониторинг при работе в продакшн-средах.

## Основные этапы обработки

1. **Подготовка входных данных** — размещение цифровых PDF в директории `input/`.
2. **Запуск конвертации** — скрипт `convert-pdf-to-markdown.sh` выбирает локальный backend (Docling) или Airflow-оркестрацию, проверяет зависимости и формирует команды.
3. **Docling-конвертация** — `local_converter` вызывает `DoclingProcessor.process_document`, получая Markdown, таблицы, изображения, метаданные и статистику.
4. **Нормализация вывода** — Markdown очищается от лишних пустых строк, бинарные активы (изображения, таблицы) сохраняются рядом.
5. **Сохранение артефактов** — готовые Markdown-файлы помещаются в `output/zh`, метаданные — в `output/metadata`, дополнительные активы — в отдельные каталоги.
6. **Проверка качества** — модули `quality_assurance` анализируют результат (структура, полнота, ошибки парсинга).
7. **Опциональный перевод** — скрипт `translate-documents.sh` и модуль `translator` конвертируют исходный китайский Markdown в английский (`output/en`) или русский (`output/ru`).

## Модули и компоненты

### `document_processor`

Ключевая директория, отвечающая за извлечение структуры PDF:

- **`docling_processor.py`** — обёртка над Docling API. Управляет инициализацией конвертера, условным включением OCR, chunking-стратегиями и экспортом изображений/таблиц.
- **`local_converter.py`** — CLI-утилита для локальной конвертации. Организует асинхронную обработку, нормализует Markdown, сохраняет результаты и формирует JSON-ответы для shell-скриптов.
- **`ocr_processor.py`** — вспомогательные функции для случаев, когда необходим OCR (например, гибридные документы). Включается только по запросу.
- **`structure_analyzer.py`** и **`table_extractor.py`** — дополнительные инструменты для углублённого анализа структуры и таблиц, интегрируются с QA-этапами.
- **`main.py`** — точка входа для запуска процессора как самостоятельного сервиса или CLI.
- **`__init__.py`** — экспортирует публичные классы и конфигурации для переиспользования в других частях проекта.

### `translator`

Модуль локализации Markdown-контента:

- **`translator.py`** — основной CLI/скрипт перевода, использующий заранее настроенные LLM или API.
- **`translation_prompts.py`** — шаблоны промптов для высококачественного перевода с учётом сохранения структуры Markdown.
- **`config.py`** — конфигурация доступа к моделям/эндпоинтам, параметры температуры, максимальной длины и др.
- **`requirements-translator.txt`** — список зависимостей для окружения переводчика.

Перевод запускается из `translate-documents.sh` и может использовать уже сконвертированные Markdown-документы.

### `quality_assurance`

Каталог с проверками и метриками качества. Возможные подсистемы:

- Анализ структурной целостности Markdown.
- Проверка корректности ссылок и изображений.
- Сравнение объёма контента между исходным PDF и Markdown.

Структура гибкая: модули могут подключаться на этапе пост-обработки после завершения Docling-конвертации.

### Вспомогательные сервисы и инфраструктура

- **`airflow/`** — DAG'и и конфигурация для оркестрации пайплайна через Apache Airflow.
- **`flask/`** — REST API (например, для приёма задач конвертации по сети).
- **`grafana/`, `prometheus/`** — метрики и визуализация качества/производительности пайплайна.
- **`vllm/`** — окружение для высокопроизводительных LLM-моделей, используемых на этапе перевода или QA.
- **`docs/`** — дополнительная документация, схемы и материалы по архитектуре.

## Рабочие сценарии

### Конвертация цифровых PDF → Markdown

1. Поместите PDF-файлы в папку `input/`.
2. Убедитесь, что виртуальное окружение содержит зависимости из `document_processor/requirements-docprocessor.txt`.
3. Запустите:
   ```bash
   bash convert-pdf-to-markdown.sh
   ```
4. Скрипт проверит наличие сервисов (Airflow — опционально), сформирует команды для `document_processor.local_converter` и сохранит результаты в `output/zh` и `output/metadata`.
5. Логи конкретного запуска сохраняются в `logs/conversion_*.log`.

### Опциональный перевод Markdown

1. Убедитесь, что в `output/zh` присутствуют исходные Markdown-файлы.
2. Подготовьте зависимости переводчика (`translator/requirements-translator.txt`).
3. Запустите:
   ```bash
   bash translate-documents.sh
   ```
4. В интерактивном меню выберите сценарий:
   - Полная обработка PDF с последующим переводом на русский (`output/ru`) или английский (`output/en`).
   - Перевод уже готовых Markdown без повторной конвертации.
5. Скрипт при необходимости инициирует повторную Docling-конвертацию, затем вызывает `translator.translator` для LLM-перевода.

## Конфигурация

### `.env` и ключевые переменные

Основные переменные окружения считываются из `.env` в корне проекта:

- `CONVERSION_BACKEND` — `local` (Docling) или `airflow`.
- `CONVERTER_ENABLE_OCR_BOOL` — включает OCR только при необходимости гибридных документов.
- `LOCAL_ALLOW_OCR_FALLBACK` — разрешает автоматический переход на OCR при сбоях цифровой конвертации.
- `LOCAL_EXPORT_RAW_TEXT`, `LOCAL_OVERWRITE_OUTPUT`, `LOCAL_CONVERTER_VERBOSE` — дополнительные опции CLI.
- `AIRFLOW_BASE_URL_HOST`, `AIRFLOW_USERNAME`, `AIRFLOW_PASSWORD` — параметры подключения к Airflow.
- Переменные переводчика (`TRANSLATOR_*`) — язык назначения, модель, ключи доступа и т.д.

### Настройка окружения

1. Создайте виртуальное окружение Python для конвертера и установите зависимости:
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   pip install -r document_processor/requirements-docprocessor.txt
   ```
2. Для перевода активируйте отдельное окружение либо дополните текущее зависимостями из `translator/requirements-translator.txt`.
3. При использовании Airflow/Grafana/Prometheus запустите инфраструктуру через `docker-compose.yml`.

## Структура репозитория

```
├── convert-pdf-to-markdown.sh     # Основной скрипт конвертации PDF → MD
├── translate-documents.sh         # Универсальный скрипт перевода
├── document_processor/            # Docling-пайплайн и вспомогательные модули
├── translator/                    # Перевод Markdown на EN/RU
├── quality_assurance/             # Пост-обработка и проверки качества
├── input/                         # Входные PDF-файлы (по умолчанию)
├── output/
│   ├── zh/                        # Markdown на китайском
│   ├── ru/                        # Переводы на русский
│   ├── en/                        # Переводы на английский
│   └── metadata/                  # JSON с метаданными конвертации
├── logs/                          # Логи конвертации и перевода
├── airflow/, flask/, grafana/, prometheus/, vllm/  # Инфраструктура
└── docs/                          # Дополнительные материалы
```

## Отладка и мониторинг

- **Логи** — директория `logs/` содержит файлы вида `conversion_*.log` и `translation_*.log` с пометкой времени запуска и PID.
- **Возврат значений** — `convert-pdf-to-markdown.sh` выводит JSON-строки с результатами обработки каждого файла, пригодные для дальнейшего анализа (`jq`).
- **Метрики** — интеграция с Prometheus/Grafana позволяет собирать статистику по времени обработки, ошибкам, статусам переводов.
- **Airflow UI** — при работе через оркестратор статус задач отображается в стандартном веб-интерфейсе Airflow.

## Дальнейшее развитие

- Расширение набора проверок в `quality_assurance` (лексические, семантические, статистические метрики).
- Поддержка дополнительных языков и моделей перевода в модуле `translator`.
- Автоматическая синхронизация артефактов в сторонние системы (CMS, базы знаний).
- Интеграция с системами управления задачами (Jira, ClickUp) через Flask API.

