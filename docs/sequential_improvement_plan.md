# Sequential Improvement Plan for PDF → Markdown Pipeline

## 1. Current Run Summary (Baseline Reference)
- Последний запуск конвейера завершился успешно и сгенерировал Markdown-файл `output/zh/1759009195_test_short.md` (171 строк, 15903 байта). Логи CLI подтверждают единый лог-файл и успешное завершение. 【F:logs/conversion_20250928_004615.log†L1-L10】
- На этапе `document_preprocessing.process_document_with_api` в запросе к document-processor передается `use_ocr: True`, хотя входной файл имеет текстовый слой. Это означает, что фактическая конфигурация OCR не была проверена после внедренных правок первого этапа. 【F:logs/dag_id=document_preprocessing/run_id=manual__2025-09-27T21:39:58.818513+00:00/task_id=process_document_with_api/attempt=1.log†L11-L11】

## 2. Анализ результата Markdown
- Таблица команд в начале документа «расползается»: каждая строка разорвана и сопровождается «висячими» фрагментами из-за ошибочной пост-обработки таблиц. 【F:output/zh/1759009195_test_short.md†L5-L33】
- В блоках с описаниями команд нарушено форматирование таблиц (появляются отдельные столбцы с пустыми значениями и произвольные переносы), что указывает на потерю исходной структуры. 【F:output/zh/1759009195_test_short.md†L77-L115】

## 3. Ограничения и риски
- Мы уже изменяли скрипты конвертации и перевода на первом этапе. Повторные правки без подтверждения результатов нарушат требование последовательности и усложнят отладку.
- Автоматический перевод и контентные трансформации модифицируют таблицы, поэтому любые исправления следует вносить по одному модулю с обязательной регрессией.

## 4. План пошаговых действий

### Этап A — Подтверждение результатов первого этапа (без новых правок)
1. **Цель:** убедиться, что реализованное ранее объединение логов и проксирование флага OCR работают штатно.
2. **Действия проверки:**
   - Запустить `CONVERTER_ENABLE_OCR=false ./convert-pdf-to-markdown.sh <pdf>` и убедиться, что в логах CLI выводится «OCR отключен». 【F:convert-pdf-to-markdown.sh†L69-L104】
   - В логах Airflow `process_document_with_api` проверить, что `use_ocr` передается как `False`. При несовпадении — зафиксировать фактическую конфигурацию без правок в коде.
   - Запустить `./translate-documents.sh --dry-run` (или предусмотренный безопасный режим) и убедиться, что логирование также остается единым файлом.
3. **Критерий завершения:** подтверждено, что текущие правки выполняют задачу или выявлено воспроизводимое расхождение, которое можно решать на следующем этапе.

### Этап B — Диагностика причины включенного OCR (при условии, что Этап A выявит проблему)
1. **Цель:** локализовать, где именно «переключается» `enable_ocr` без модификаций других модулей.
2. **Действия:**
   - Проанализировать bridge-конфигурацию после Stage 1 (при необходимости временно вывести ее в лог) и зафиксировать значение `enable_ocr`.
   - Проверить входные переменные окружения (.env, экспортируемые переменные) на наличие принудительного включения OCR.
3. **Результат:** документированная причина несоответствия. Только после этого принимается решение о правке конкретного участка кода.

### Этап C — Исправление форматирования таблиц (после подтверждения стабильности OCR)
1. **Цель:** устранить искажения таблиц без влияния на остальные элементы Markdown.
2. **Подход:**
   - Собрать промежуточный Markdown после Stage 1 и Stage 2 до включения LLM-улучшений.
   - Написать модульные тесты на функции обработки таблиц (`enhance_chinese_tables`, `clean_chinese_formatting`).
   - Внести минимальные правки в конкретную функцию, подтвердив тестами отсутствие регрессий.
3. **Проверка:** сравнить результирующий Markdown с исходным PDF по ключевым таблицам (визуальный дифф или ручная верификация).

### Этап D — Контроль переводческого этапа
1. **Цель:** удостовериться, что переводчик сохраняет структуру таблиц и кодовых блоков.
2. **Шаги:**
   - Провести пробный перевод Markdown с отключенными автокоррекциями.
   - Проверить логи на предмет сохранения единого файла и корректного батчинга.
3. **После подтверждения:** только затем корректировать chunking/LLM-логику при необходимости.

## 5. Инструкция по проверке эффективности после каждого этапа
- После **Этапа A**: повторить полный прогон конвейера на эталонном PDF, убедиться, что в логах OCR отключен, и зафиксировать версию результата Markdown как «baseline» для сравнения.
- После **Этапа B** (если применялся): прогнать Stage 1, убедиться, что `use_ocr` соответствует ожидаемому значению, и документировать изменение.
- После **Этапа C**: выполнить Stage 2 и сравнить таблицы Markdown с оригиналом; при необходимости использовать автоматизированный сравниватель таблиц.
- После **Этапа D**: провести перевод и убедиться, что структура Markdown не искажается.

## 6. Итоговое требование
Все дальнейшие изменения в коде выполняются строго после прохождения описанных проверок предыдущего этапа. Это обеспечивает последовательность и упрощает анализ регрессий, соответствуя вашему требованию.
