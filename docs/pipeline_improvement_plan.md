# План поэтапного исправления конвейера PDF→Markdown→Перевод

## Цели
- Добиться детерминированной конверсии цифровых PDF в Markdown с 100% совпадением визуального представления.
- После стабилизации конверсии включить полноценный перевод с китайского на английский и русский.
- Синхронизировать DAG'и Airflow и микросервисы, исключив дублирование логики и ложноположительные статусы QA.

## Этап 0. Анализ логов и текущего состояния
1. Зафиксировать отсутствующий запуск стадии перевода в `convert-pdf-to-markdown.sh` и DAG `translation_pipeline`.
2. Зафиксировать несоответствие количества символов между Stage 1 и Stage 2 (рост в 8×).
3. Подтвердить, что визуальная проверка (Level 2 QA) не конвертирует PDF в изображения (возвращаются чёрные заглушки).
4. Подтвердить, что OCR-валидация Level 1 использует симуляцию и не выявляет ошибок.
5. Документировать длительность узких мест: document-processor (18.55 с) и серия vLLM-вызовов Stage 2 (277 с).

## Этап 1. Document Preprocessing (DAG  сервис)
- DAG `document_preprocessing`:
  - Жёстко завершаем таск при неудачном ответе API вместо продолжения с «безопасным JSON».
  - Подготавливаем чистые мостовые файлы (`stage1_bridge_*.json`) с проверкой существования.
- Сервис `document_processor`:
  - Потоковое сохранение входного файла без загрузки целиком в память.
  - Валидация сигнатуры `%PDF` и размера на лету.
  - Централизованный запуск Prometheus, исключающий повторные `start_http_server`.

## Этап 2. Content Transformation
- Устранить дублирование и рост объёма Markdown: пересмотреть объединение чанков и работу автокорректоров.
- Исправить сбор и логирование метрик времени: фиксировать фактическую длительность 277 с.
- Настроить параллелизм vLLM-вызовов с контролем нагрузки (async или multiprocessing).

## Этап 3. Translation
- Удалить словарный «перевод» в DAG `translation_pipeline` и подключить сервис `translator`/vLLM.
- Исправить кэш FastAPI-переводчика и работу метрик Prometheus (`collect()` вместо `_value`).
- Включить генерацию файлов `*.en.md` и `*.ru.md` с проверкой качества (BLEU/character coverage).
- Активировать стадию перевода в `convert-pdf-to-markdown.sh` после завершения Этапа 2.

## Этап 4. Quality Assurance
- Level 1: Подключить реальный OCR (PaddleOCR/Tesseract) через `OCRValidator` и использовать согласование confidence.
- Level 2: Реализовать конвертацию PDF → изображения (PyMuPDF или `pdf2image`) вместо заглушки.
- Level 3: Удалить симуляцию sentence embeddings, использовать SentenceTransformer или сервис.
- Level 4: Ограничить auto-correction целевыми сегментами, переиспользовать vLLM-сессию.
- Синхронизировать статусы: при ошибках валидации возвращать `FAILED`, а не `Needs Review`.

## Этап 5. Оркестрация и мониторинг
- `orchestrator_dag.py`: прекращать пайплайн при провале QA (<90%).
- Отправлять метрики в Prometheus/Grafana для каждого этапа (фактические времена, статусы, количество ретраев).
- Добавить детализированные логи и алерты по отсутствию переводов EN/RU.

## Этап 6. Финализация и перевод
- После достижения 100% совпадения PDF ↔ Markdown подтвердить готовность Stage 3.
- Активировать перевод в скриптах и DAG'ах, выполнить интеграционные тесты на эталонных документах.
- Обновить документацию по запуску и SLA (целевое время обработки, пороги качества).

